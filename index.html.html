<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub Central de Consultas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6a11cb;
            --secondary: #2575fc;
            --accent: #8a2be2;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --disabled: #6c757d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            color: var(--dark);
        }
        
        header {
            background: linear-gradient(to right, var(--primary), var(--accent));
            padding: 20px;
            text-align: center;
            color: white;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: linear-gradient(to right, var(--primary), var(--accent));
            overflow-x: auto;
        }
        
        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .tab-button.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 3px solid white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-box {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 50px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-box:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2);
            outline: none;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: linear-gradient(to right, var(--primary), var(--accent));
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
            text-align: center;
            cursor: pointer;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--accent));
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-disabled {
            background: var(--disabled);
            color: white;
            border: none;
            cursor: not-allowed;
        }
        
        .cnae-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            resize: vertical;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-obrigatorio {
            background-color: var(--success);
        }
        
        .status-nao-obrigatorio {
            background-color: var(--warning);
        }
        
        .status-nao-encontrado {
            background-color: var(--danger);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--primary);
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            animation: spin 1s infinite linear;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .state-search {
            margin-top: 20px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: white;
            margin-top: 30px;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .tab-button {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Hub Central de Consultas</h1>
            <p>Dados em tempo real via Google Sheets</p>
        </header>
        
        <div class="tabs">
            <button class="tab-button active" data-tab="hub-im">HUB IM</button>
            <button class="tab-button" data-tab="hub-ie">HUB IE</button>
        </div>
        
        <div class="tab-content active" id="hub-im">
            <div class="search-container">
                <input type="text" class="search-box" id="search-city" placeholder="Digite o nome da cidade para carregar os dados...">
            </div>
            
            <div class="table-container">
                <table id="municipal-table">
                    <thead>
                        <tr>
                            <th>Cidade - UF</th>
                            <th>Tem Taxa?</th>
                            <th>Portal Ficha</th>
                            <th>Portal Taxa</th>
                            <th>Observações</th>
                        </tr>
                    </thead>
                    <tbody id="municipal-data">
                        <tr>
                            <td colspan="5" class="loading">
                                <i class="fas fa-spinner"></i><br>
                                Digite o nome de uma cidade para carregar os dados
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="hub-ie">
            <div class="search-container">
                <textarea class="cnae-input" id="cnae-input" placeholder="Cole os CNAEs aqui (separados por vírgula, traços, pontos, espaço ou quebra de linha)"></textarea>
                <button class="btn btn-primary" id="search-cnae">Consultar CNAEs</button>
                
                <div class="state-search">
                    <input type="text" class="search-box" id="search-state" placeholder="Digite o estado para consultar procedimento de IE">
                    <button class="btn btn-primary" id="search-state-btn">Consultar Estado</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="cnae-table">
                    <thead>
                        <tr>
                            <th>Código CNAE</th>
                            <th>Descrição</th>
                            <th>IE Obrigatória</th>
                            <th>Observações</th>
                        </tr>
                    </thead>
                    <tbody id="cnae-data">
                        <tr>
                            <td colspan="4" class="loading">
                                <i class="fas fa-info-circle"></i><br>
                                Digite os CNAEs ou um estado para consultar
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="table-container" id="state-results" style="display: none; margin-top: 20px;">
                <table id="state-table">
                    <thead>
                        <tr>
                            <th>Estado</th>
                            <th>Procedimento</th>
                            <th>Ficha Cadastral</th>
                        </tr>
                    </thead>
                    <tbody id="state-data">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Desenvolvido para consultas em tempo real via Google Sheets | Atualizado automaticamente</p>
    </footer>

    <script>
        // URLs das planilhas (já corrigidas para CSV)
        const SPREADSHEET_URLS = {
            fichas: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRoeS2iHPQIqM8oGltV5UFvdpT_LLVZiYFtKaDaWYaNFLfrz5lzuutTFX38lnXmpkP50Xh-8WZ_6VJz/pub?output=csv&gid=0',
            taxas: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRoeS2iHPQIqM8oGltV5UFvdpT_LLVZiYFtKaDaWYaNFLfrz5lzuutTFX38lnXmpkP50Xh-8WZ_6VJz/pub?output=csv&gid=1943132411',
            verificacao_ie: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRoeS2iHPQIqM8oGltV5UFvdpT_LLVZiYFtKaDaWYaNFLfrz5lzuutTFX38lnXmpkP50Xh-8WZ_6VJz/pub?output=csv&gid=876347723',
            procedimento_ie: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRoeS2iHPQIqM8oGltV5UFvdpT_LLVZiYFtKaDaWYaNFLfrz5lzuutTFX38lnXmpkP50Xh-8WZ_6VJz/pub?output=csv&gid=1078407086'
        };

        // Variáveis para armazenar os dados
        let fichasData = [];
        let taxasData = [];
        let verificacaoIeData = [];
        let procedimentoIeData = [];
        
        // Elementos DOM
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const searchCityInput = document.getElementById('search-city');
        const municipalDataBody = document.getElementById('municipal-data');
        const cnaeInput = document.getElementById('cnae-input');
        const searchCnaeButton = document.getElementById('search-cnae');
        const cnaeDataBody = document.getElementById('cnae-data');
        const searchStateInput = document.getElementById('search-state');
        const searchStateButton = document.getElementById('search-state-btn');
        const stateResults = document.getElementById('state-results');
        const stateDataBody = document.getElementById('state-data');
        
        // Configuração das abas
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                
                // Remove a classe active de todos os botões e conteúdos
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Adiciona a classe active ao botão e conteúdo clicado
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Função para carregar dados CSV
        async function loadCSV(url) {
            try {
                const response = await fetch(url);
                const csvData = await response.text();
                return parseCSV(csvData);
            } catch (error) {
                console.error('Erro ao carregar CSV:', error);
                return [];
            }
        }
        
        // Função para converter CSV em array de objetos
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(header => header.trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(',').map(value => value.trim());
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = values[i] || '';
                });
                return obj;
            }).filter(obj => Object.values(obj).some(value => value !== ''));
        }
        
        // Carregar todos os dados ao inicializar
        async function loadAllData() {
            try {
                [fichasData, taxasData, verificacaoIeData, procedimentoIeData] = await Promise.all([
                    loadCSV(SPREADSHEET_URLS.fichas),
                    loadCSV(SPREADSHEET_URLS.taxas),
                    loadCSV(SPREADSHEET_URLS.verificacao_ie),
                    loadCSV(SPREADSHEET_URLS.procedimento_ie)
                ]);
                
                console.log('Dados carregados com sucesso!');
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }
        
        // Pesquisar cidades (HUB IM)
        searchCityInput.addEventListener('input', debounce(() => {
            const searchTerm = searchCityInput.value.trim().toLowerCase();
            
            if (searchTerm.length < 3) {
                municipalDataBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="loading">
                            <i class="fas fa-info-circle"></i><br>
                            Digite pelo menos 3 caracteres para pesquisar
                        </td>
                    </tr>
                `;
                return;
            }
            
            municipalDataBody.innerHTML = `
                <tr>
                    <td colspan="5" class="loading">
                        <i class="fas fa-spinner"></i><br>
                        Carregando dados...
                    </td>
                </tr>
            `;
            
            setTimeout(() => {
                displayMunicipalData(searchTerm);
            }, 300);
        }, 500));
        
        // Exibir dados municipais
        function displayMunicipalData(searchTerm) {
            // Filtrar dados de fichas e taxas baseado no termo de pesquisa
            const filteredFichas = fichasData.filter(item => 
                item.Cidade && item.Cidade.toLowerCase().includes(searchTerm)
            );
            
            const filteredTaxas = taxasData.filter(item => 
                item.Cidade && item.Cidade.toLowerCase().includes(searchTerm)
            );
            
            // Combinar dados
            const combinedData = filteredFichas.map(ficha => {
                const taxa = filteredTaxas.find(t => t.Cidade === ficha.Cidade) || {};
                
                return {
                    cidade: ficha.Cidade || '',
                    temTaxa: taxa['Tem Taxa?'] || 'Não informado',
                    portalFicha: ficha['Portal Link'] || '',
                    portalTaxa: taxa['Portal Link'] || '',
                    observacoes: ficha.Observações || taxa.Observações || ''
                };
            });
            
            if (combinedData.length === 0) {
                municipalDataBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="loading">
                            <i class="fas fa-exclamation-circle"></i><br>
                            Nenhuma cidade encontrada para "${searchTerm}"
                        </td>
                    </tr>
                `;
                return;
            }
            
            municipalDataBody.innerHTML = combinedData.map(item => `
                <tr>
                    <td>${item.cidade}</td>
                    <td>${item.temTaxa}</td>
                    <td>
                        ${item.portalFicha ? 
                            `<a href="${item.portalFicha}" target="_blank" class="btn btn-primary">Acessar Ficha</a>` : 
                            `<span class="btn btn-disabled">Indisponível</span>`
                        }
                    </td>
                    <td>
                        ${item.portalTaxa ? 
                            `<a href="${item.portalTaxa}" target="_blank" class="btn btn-primary">Acessar Taxa</a>` : 
                            `<span class="btn btn-disabled">Indisponível</span>`
                        }
                    </td>
                    <td>${item.observacoes}</td>
                </tr>
            `).join('');
        }
        
        // Consultar CNAEs (HUB IE)
        searchCnaeButton.addEventListener('click', () => {
            const input = cnaeInput.value.trim();
            
            if (!input) {
                alert('Por favor, insira pelo menos um CNAE para consultar.');
                return;
            }
            
            cnaeDataBody.innerHTML = `
                <tr>
                    <td colspan="4" class="loading">
                        <i class="fas fa-spinner"></i><br>
                        Processando consulta...
                    </td>
                </tr>
            `;
            
            setTimeout(() => {
                searchCNAEs(input);
            }, 300);
        });
        
        // Pesquisar CNAEs
        function searchCNAEs(input) {
            // Extrair CNAEs do input (suporta vários formatos)
            const cnaeList = input.split(/[\s,\n.-]+/).filter(item => item.trim() !== '').map(item => {
                // Tentar encontrar código CNAE (formato xxxx-x/xx)
                const cnaePattern = /(\d{4}-\d\/\d{2})/;
                const match = item.match(cnaePattern);
                return match ? match[0] : item;
            });
            
            const results = [];
            
            cnaeList.forEach(cnae => {
                // Buscar por código ou descrição
                const found = verificacaoIeData.find(item => 
                    item['Código CNAE'] === cnae || 
                    item['Descrição do CNAE']?.toLowerCase().includes(cnae.toLowerCase())
                );
                
                if (found) {
                    results.push({
                        codigo: found['Código CNAE'] || '',
                        descricao: found['Descrição do CNAE'] || '',
                        obrigatoria: found['Inscrição Estadual Obrigatória'] || '',
                        observacoes: found.Observações || ''
                    });
                } else {
                    results.push({
                        codigo: cnae,
                        descricao: 'CNAE não encontrado',
                        obrigatoria: '',
                        observacoes: ''
                    });
                }
            });
            
            displayCNAEResults(results);
        }
        
        // Exibir resultados de CNAE
        function displayCNAEResults(results) {
            if (results.length === 0) {
                cnaeDataBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="loading">
                            <i class="fas fa-exclamation-circle"></i><br>
                            Nenhum resultado encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            cnaeDataBody.innerHTML = results.map(item => `
                <tr>
                    <td>${item.codigo}</td>
                    <td>${item.descricao}</td>
                    <td>
                        ${item.obrigatoria ? 
                            `<span class="status-indicator status-obrigatorio"></span> ${item.obrigatoria}` : 
                            item.descricao === 'CNAE não encontrado' ? 
                                `<span class="status-indicator status-nao-encontrado"></span> Não encontrado` : 
                                `<span class="status-indicator status-nao-obrigatorio"></span> Não especificado`
                        }
                    </td>
                    <td>${item.observacoes}</td>
                </tr>
            `).join('');
        }
        
        // Consultar estado (HUB IE)
        searchStateButton.addEventListener('click', () => {
            const state = searchStateInput.value.trim();
            
            if (!state) {
                alert('Por favor, insira um estado para consultar.');
                return;
            }
            
            stateDataBody.innerHTML = `
                <tr>
                    <td colspan="3" class="loading">
                        <i class="fas fa-spinner"></i><br>
                        Buscando procedimentos...
                    </td>
                </tr>
            `;
            
            stateResults.style.display = 'block';
            
            setTimeout(() => {
                searchState(state);
            }, 300);
        });
        
        // Pesquisar estado
        function searchState(state) {
            const found = procedimentoIeData.find(item => 
                item.Estado?.toLowerCase().includes(state.toLowerCase())
            );
            
            if (found) {
                stateDataBody.innerHTML = `
                    <tr>
                        <td>${found.Estado || ''}</td>
                        <td>${found.Procedimento || ''}</td>
                        <td>
                            ${found['Portal link'] ? 
                                `<a href="${found['Portal link']}" target="_blank" class="btn btn-primary">Baixar Ficha</a>` : 
                                `<span class="btn btn-disabled">Indisponível</span>`
                            }
                        </td>
                    </tr>
                `;
            } else {
                stateDataBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="loading">
                            <i class="fas fa-exclamation-circle"></i><br>
                            Nenhum procedimento encontrado para "${state}"
                        </td>
                    </tr>
                `;
            }
        }
        
        // Utilitário: debounce para melhor performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Inicializar a aplicação
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
        });
    </script>
</body>
</html>

